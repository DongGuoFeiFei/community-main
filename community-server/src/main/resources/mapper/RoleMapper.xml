<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.communityserver.mapper.RoleMapper">
    <insert id="insertRoleMenu">
        INSERT INTO role_menu (role_id, menu_id, create_time)
        VALUES
        <foreach collection="param.ids" item="menuId" separator=",">
            (#{param.id}, #{menuId}, NOW())
        </foreach>
    </insert>
    <delete id="deleteRoleMenuByRoleId">
        DELETE
        FROM role_menu
        WHERE role_id = #{id}
    </delete>

    <select id="selectRoleKeysByUserId" resultType="java.lang.String">
        SELECT role_key
        FROM (SELECT DISTINCT r.role_key,
                              r.role_sort
              FROM role r
                       JOIN user_role ur ON r.role_id = ur.role_id
                       JOIN USER u ON ur.user_id = u.user_id
              WHERE u.user_id = #{userId}
                AND r.STATUS = 1) t
        ORDER BY role_sort;
    </select>
    <select id="selectUserRoles" resultType="com.example.communityserver.entity.model.Role">
        SELECT r.role_id,
               r.role_name,
               r.role_key,
               r.role_sort,
               r.status,
               r.create_time,
               r.remark
        FROM role r
                 JOIN user_role ur ON r.role_id = ur.role_id
                 JOIN user u ON ur.user_id = u.user_id
        WHERE u.user_id = #{userId}
          AND r.status = 1
        ORDER BY r.role_sort
    </select>
</mapper>
